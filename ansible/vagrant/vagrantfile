Vagrant.configure("2") do |config|
  # Configuration par défaut
  config.vm.box_check_update = false
  
  # Machine de contrôle Ansible (Ubuntu)
  config.vm.define "controller" do |controller|
    controller.vm.box = "ubuntu/jammy64"
    controller.vm.hostname = "controller"
    controller.vm.network "private_network", ip: "192.168.56.200"
    
    controller.vm.provider "virtualbox" do |vb|
      vb.name = "controller"
      vb.memory = "2048"
      vb.cpus = 2
    end
    
    controller.vm.provision "shell", inline: <<-SHELL
      apt-get update
      apt-get install -y software-properties-common sshpass
      add-apt-repository --yes --update ppa:ansible/ansible
      apt-get install -y ansible
      
      # Configuration SSH
      mkdir -p /home/vagrant/.ssh
      ssh-keygen -t rsa -b 2048 -f /home/vagrant/.ssh/id_rsa -N ""
      chown -R vagrant:vagrant /home/vagrant/.ssh
      cp /home/vagrant/.ssh/id_rsa.pub /vagrant/ansible_key.pub
    SHELL
  end
  
  # Serveurs Ubuntu
  (1..2).each do |i|
    config.vm.define "ubuntu#{i}" do |ubuntu|
      ubuntu.vm.box = "ubuntu/jammy64"
      ubuntu.vm.hostname = "ubuntu#{i}"
      ubuntu.vm.network "private_network", ip: "192.168.56.20#{i}"
      
      ubuntu.vm.provider "virtualbox" do |vb|
        vb.name = "ubuntu#{i}"
        vb.memory = "1024"
        vb.cpus = 1
      end
      
      ubuntu.vm.provision "shell", inline: <<-SHELL
        apt-get update
        apt-get install -y python3 python3-pip
        
        # Configuration SSH
        if [ -f /vagrant/ansible_key.pub ]; then
          mkdir -p /home/vagrant/.ssh
          cat /vagrant/ansible_key.pub >> /home/vagrant/.ssh/authorized_keys
          chown -R vagrant:vagrant /home/vagrant/.ssh
          chmod 600 /home/vagrant/.ssh/authorized_keys
        fi
        echo "Ubuntu#{i} configuré"
      SHELL
    end
  end
  
  # Serveurs CentOS
  (1..2).each do |i|
    config.vm.define "centos#{i}" do |centos|
      centos.vm.box = "centos/7"
      centos.vm.hostname = "centos#{i}"
      centos.vm.network "private_network", ip: "192.168.56.20#{i + 2}"
      
      centos.vm.provider "virtualbox" do |vb|
        vb.name = "centos#{i}"
        vb.memory = "1024"
        vb.cpus = 1
      end
      
      centos.vm.provision "shell", inline: <<-SHELL
        yum update -y
        yum install -y python3 python3-pip
        
        # Configuration SSH
        if [ -f /vagrant/ansible_key.pub ]; then
          mkdir -p /home/vagrant/.ssh
          cat /vagrant/ansible_key.pub >> /home/vagrant/.ssh/authorized_keys
          chown -R vagrant:vagrant /home/vagrant/.ssh
          chmod 600 /home/vagrant/.ssh/authorized_keys
        fi
        echo "CentOS#{i} configuré"
      SHELL
    end
  end
end