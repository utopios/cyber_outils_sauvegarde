---
# Inventaire PCA/PRA - FinSecure
# Architecture: 2 VMs (datacenters) avec conteneurs Docker pour les applications

all:
  vars:
    ansible_python_interpreter: /usr/bin/python3
    company: "FinSecure"
    environment: production

  children:
    # ============================================
    # DATACENTER PRINCIPAL - PARIS
    # ============================================
    dc_paris:
      vars:
        datacenter: paris
        dc_role: primary
        dc_location: "Paris, France"
        dc_network: "10.1.0.0/16"

      hosts:
        # VM hôte du datacenter Paris
        vm-paris:
          ansible_host: 192.168.56.10
          ansible_user: vagrant
          # Conteneurs hébergés sur cette VM
          docker_containers:
            - name: haproxy-paris
              image: haproxy:2.8
              ports: ["80:80", "443:443", "8404:8404"]
              network: dc_paris_net
            - name: app-paris-01
              image: finsecure/api:latest
              ports: ["8081:8080"]
              network: dc_paris_net
            - name: app-paris-02
              image: finsecure/api:latest
              ports: ["8082:8080"]
              network: dc_paris_net
            - name: postgres-primary
              image: postgres:15
              ports: ["5432:5432"]
              network: dc_paris_net
              volumes:
                - pg_data_paris:/var/lib/postgresql/data
            - name: redis-paris
              image: redis:7-alpine
              ports: ["6379:6379"]
              network: dc_paris_net

    # ============================================
    # DATACENTER SECOURS - LYON
    # ============================================
    dc_lyon:
      vars:
        datacenter: lyon
        dc_role: standby
        dc_location: "Lyon, France"
        dc_network: "10.2.0.0/16"

      hosts:
        # VM hôte du datacenter Lyon
        vm-lyon:
          ansible_host: 192.168.56.20
          ansible_user: vagrant
          # Conteneurs hébergés sur cette VM
          docker_containers:
            - name: haproxy-lyon
              image: haproxy:2.8
              ports: ["80:80", "443:443", "8404:8404"]
              network: dc_lyon_net
            - name: app-lyon-01
              image: finsecure/api:latest
              ports: ["8081:8080"]
              network: dc_lyon_net
            - name: app-lyon-02
              image: finsecure/api:latest
              ports: ["8082:8080"]
              network: dc_lyon_net
            - name: postgres-standby
              image: postgres:15
              ports: ["5432:5432"]
              network: dc_lyon_net
              volumes:
                - pg_data_lyon:/var/lib/postgresql/data
            - name: redis-lyon
              image: redis:7-alpine
              ports: ["6379:6379"]
              network: dc_lyon_net

    # ============================================
    # GROUPES FONCTIONNELS (cross-DC)
    # ============================================

    # Tous les load balancers
    loadbalancers:
      hosts:
        vm-paris:
          lb_container: haproxy-paris
          lb_role: primary
        vm-lyon:
          lb_container: haproxy-lyon
          lb_role: standby

    # Tous les serveurs d'application
    app_servers:
      hosts:
        vm-paris:
          app_containers:
            - app-paris-01
            - app-paris-02
        vm-lyon:
          app_containers:
            - app-lyon-01
            - app-lyon-02

    # Bases de données PostgreSQL
    databases:
      children:
        db_primary:
          hosts:
            vm-paris:
              pg_container: postgres-primary
              pg_role: primary
              pg_replication_slot: lyon_replica
        db_standby:
          hosts:
            vm-lyon:
              pg_container: postgres-standby
              pg_role: standby
              pg_upstream: vm-paris

    # Serveurs Redis
    redis_servers:
      hosts:
        vm-paris:
          redis_container: redis-paris
          redis_role: master
        vm-lyon:
          redis_container: redis-lyon
          redis_role: replica

    # ============================================
    # GROUPES PAR CRITICITE (basé sur RTO/RPO)
    # ============================================

    # Services critiques (RTO < 30 min)
    critical_services:
      children:
        databases:
        loadbalancers:
      vars:
        rto_minutes: 15
        monitoring_priority: high

    # Services standards (RTO 1-4h)
    standard_services:
      children:
        app_servers:
      vars:
        rto_minutes: 60
        monitoring_priority: medium
