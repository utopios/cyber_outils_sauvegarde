# HAProxy Configuration - DC Paris (Primary)
# Load balancer pour les services FinSecure

global
    log stdout format raw local0
    maxconn 4096
    tune.ssl.default-dh-param 2048
    stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-keep-alive 10s
    timeout check 5s
    retries 3

# ============================================
# STATISTIQUES ET MONITORING
# ============================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:H@pr0xyStats!
    stats admin if TRUE

    # Endpoint de santé pour monitoring externe
    acl health_check path /health
    http-request return status 200 content-type text/plain string "OK" if health_check

# ============================================
# FRONTEND HTTP/HTTPS
# ============================================
frontend http_front
    bind *:80
    mode http

    # Redirection HTTPS (en production)
    # http-request redirect scheme https unless { ssl_fc }

    # ACLs pour routage
    acl is_api path_beg /api
    acl is_health path /health /actuator/health
    acl is_backoffice path_beg /backoffice

    # Routing vers backends
    use_backend api_servers if is_api
    use_backend api_servers if is_health
    use_backend backoffice_servers if is_backoffice
    default_backend api_servers

# ============================================
# BACKEND API (Services critiques - RTO 15min)
# ============================================
backend api_servers
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    # Sticky sessions si nécessaire
    # cookie SERVERID insert indirect nocache

    # Serveurs applicatifs Paris
    server app-paris-01 app-paris-01:8080 check inter 5s fall 3 rise 2 weight 100
    server app-paris-02 app-paris-02:8080 check inter 5s fall 3 rise 2 weight 100

    # Serveurs Lyon en backup (failover automatique)
    # server app-lyon-01 192.168.56.20:8081 check inter 10s fall 3 rise 2 backup
    # server app-lyon-02 192.168.56.20:8082 check inter 10s fall 3 rise 2 backup

# ============================================
# BACKEND BACKOFFICE (RTO 4h)
# ============================================
backend backoffice_servers
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    server app-paris-01 app-paris-01:8080 check inter 30s fall 3 rise 2 weight 100
    server app-paris-02 app-paris-02:8080 check inter 30s fall 3 rise 2 weight 100

# ============================================
# BACKEND POSTGRESQL (pour monitoring)
# ============================================
listen postgres_primary
    bind *:5433
    mode tcp
    option tcplog
    option tcp-check

    tcp-check connect
    tcp-check send-binary 0000002800030000 # startup packet
    tcp-check expect binary 52 # 'R' for auth request

    server postgres-primary postgres-primary:5432 check inter 10s fall 3 rise 2

# ============================================
# BACKEND REDIS (pour monitoring)
# ============================================
listen redis_primary
    bind *:6380
    mode tcp
    option tcplog
    option tcp-check

    tcp-check send PING\r\n
    tcp-check expect string +PONG

    server redis-paris redis-paris:6379 check inter 5s fall 3 rise 2
