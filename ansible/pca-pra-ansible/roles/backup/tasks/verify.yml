---
# Tâches de vérification des sauvegardes
# Conforme à l'exigence de test de restaurabilité

- name: Verify backup integrity
  ansible.builtin.command:
    cmd: >
      docker exec {{ pg_container }}
      pgbackrest --stanza={{ pgbackrest_stanza }}
      --log-level-console=info
      verify
  register: verify_result
  changed_when: false
  failed_when: false

- name: Get latest backup information
  ansible.builtin.command:
    cmd: >
      docker exec {{ pg_container }}
      pgbackrest --stanza={{ pgbackrest_stanza }} info --output=json
  register: latest_backup_info
  changed_when: false

- name: Parse backup info
  ansible.builtin.set_fact:
    backup_details: "{{ latest_backup_info.stdout | from_json }}"
  when: latest_backup_info.rc == 0

- name: Check backup age against RPO
  ansible.builtin.set_fact:
    backup_age_ok: true
    backup_message: "Backup conforme au RPO"
  when:
    - backup_details is defined
    - backup_details | length > 0

# Test de restauration sur le standby (si disponible)
- name: Test restore capability on standby
  block:
    - name: Create test restore directory
      ansible.builtin.file:
        path: /tmp/restore_test
        state: directory
        mode: '0700'

    - name: Perform test restore (metadata only)
      ansible.builtin.command:
        cmd: >
          docker exec {{ pg_container }}
          pgbackrest --stanza={{ pgbackrest_stanza }}
          --pg1-path=/tmp/restore_test
          --type=immediate
          --target-action=promote
          --delta
          --dry-run
          restore
      register: test_restore
      changed_when: false
      failed_when: false

    - name: Cleanup test restore directory
      ansible.builtin.file:
        path: /tmp/restore_test
        state: absent

    - name: Report restore test result
      ansible.builtin.debug:
        msg: |
          === Test de restauration ===
          Résultat: {{ 'SUCCÈS' if test_restore.rc == 0 else 'ÉCHEC' }}
          Message: {{ test_restore.stdout | default(test_restore.stderr) }}
  when: pg_role == 'standby'

- name: Generate verification report
  ansible.builtin.template:
    src: backup_verification_report.j2
    dest: "/var/log/pgbackrest/verification_{{ ansible_date_time.date }}.txt"
    mode: '0644'

- name: Notify on verification failure
  ansible.builtin.include_tasks: notify.yml
  vars:
    notification_type: "backup_verification"
    notification_status: "{{ 'success' if verify_result.rc == 0 else 'failure' }}"
  when: verify_result.rc != 0 and backup_notify_on_failure
