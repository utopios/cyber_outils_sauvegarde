# =============================================================================
# CONFIGURATION HAPROXY - FORMATION PS/PCA CYBERSÉCURITÉ
# =============================================================================
# Version: HAProxy 2.8
# Fichier: /etc/haproxy/haproxy.cfg
# =============================================================================

# -----------------------------------------------------------------------------
# SECTION GLOBAL
# Configuration globale du processus HAProxy
# -----------------------------------------------------------------------------
global
    # Logging
    log stdout format raw local0 info
    log stdout format raw local1 notice
    
    # Sécurité (décommenter en production)
    # chroot /var/lib/haproxy
    # user haproxy
    # group haproxy
    
    # Performance
    maxconn 50000
    spread-checks 5
    
    # SSL/TLS Configuration
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets
    
    # Tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    tune.maxrewrite 8192
    
    # Runtime API Socket
    stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

# -----------------------------------------------------------------------------
# SECTION DEFAULTS
# Valeurs par défaut pour frontends et backends
# -----------------------------------------------------------------------------
defaults
    mode http
    log global
    
    # Options HTTP
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    option httpchk
    
    # Timeouts (valeurs recommandées PS/PCA)
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 60s
    timeout check 5s
    timeout tarpit 60s
    
    # Retries et comportement erreur
    retries 3
    
    # Compression (optionnel)
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/javascript application/json

# -----------------------------------------------------------------------------
# FRONTEND HTTP (Port 80)
# Point d'entrée HTTP avec redirection HTTPS
# -----------------------------------------------------------------------------
frontend http_front
    bind *:80
    
    # --- PROTECTION DDOS / RATE LIMITING ---
    # Table de tracking par IP
    stick-table type ip size 200k expire 5m store http_req_rate(10s),http_err_rate(10s),conn_cur,conn_rate(10s),bytes_out_rate(60s)
    
    # Tracker chaque IP
    http-request track-sc0 src
    
    # Bloquer si > 100 requêtes/10s
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # Bloquer si > 30 connexions simultanées
    http-request deny deny_status 429 if { sc_conn_cur(0) gt 30 }
    
    # Bloquer si > 50% d'erreurs
    http-request deny deny_status 429 if { sc_http_err_rate(0) gt 50 }
    
    # --- PROTECTION HEADERS ---
    # Bloquer sans Host header
    http-request deny deny_status 400 unless { req.hdr(host) -m found }
    
    # Limiter nombre de headers
    http-request deny deny_status 431 if { req.fhdr_cnt(any) gt 64 }
    
    # --- BLOCAGE USER-AGENTS MALVEILLANTS ---
    acl bad_ua hdr_sub(User-Agent) -i nikto sqlmap nmap masscan
    acl bad_ua hdr_sub(User-Agent) -i havij acunetix w3af
    http-request deny deny_status 403 if bad_ua
    
    # --- PROTECTION MÉTHODES HTTP ---
    acl valid_method method GET HEAD POST PUT DELETE PATCH OPTIONS
    http-request deny deny_status 405 unless valid_method
    
    # --- PROTECTION PATH TRAVERSAL ---
    acl path_traversal path_sub -i ../ ..\
    http-request deny deny_status 403 if path_traversal
    
    # --- ACL ROUTING ---
    acl is_api path_beg /api
    acl is_health path /health /ready /live
    acl is_stats path_beg /haproxy-stats
    acl is_admin path_beg /admin
    
    # ACL par IP
    acl internal_net src 172.20.0.0/16 10.0.0.0/8 192.168.0.0/16
    
    # --- ROUTAGE ---
    # Stats uniquement depuis réseau interne
    use_backend stats_backend if is_stats internal_net
    http-request deny deny_status 403 if is_stats !internal_net
    
    # Health checks publics
    use_backend health_backend if is_health
    
    # API vers backend dédié
    use_backend api_servers if is_api
    
    # Défaut vers serveurs web
    default_backend web_servers

# -----------------------------------------------------------------------------
# FRONTEND HTTPS (Port 443)
# Point d'entrée HTTPS avec terminaison SSL
# -----------------------------------------------------------------------------
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/server.pem alpn h2,http/1.1
    
    # Même protection que HTTP
    stick-table type ip size 200k expire 5m store http_req_rate(10s),conn_cur
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    http-request deny deny_status 429 if { sc_conn_cur(0) gt 30 }
    
    # --- HEADERS SÉCURITÉ ---
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # Supprimer headers révélateurs
    http-response del-header Server
    http-response del-header X-Powered-By
    
    # --- ROUTAGE ---
    acl is_api path_beg /api
    acl is_health path /health /ready /live
    
    use_backend health_backend if is_health
    use_backend api_servers if is_api
    default_backend web_servers

# -----------------------------------------------------------------------------
# FRONTEND STATS (Port 8404)
# Page de statistiques et administration
# -----------------------------------------------------------------------------
frontend stats_front
    bind *:8404
    mode http
    
    # Restriction IP (adapter selon environnement)
    acl allowed_stats src 127.0.0.1 172.20.0.0/16 192.168.0.0/16
    http-request deny deny_status 403 unless allowed_stats
    
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:P@ssw0rd_HAProxy_2024!
    stats admin if TRUE
    stats hide-version
    stats show-legends
    stats show-desc "HAProxy PS/PCA Training Lab"
    
    # Prometheus metrics
    http-request use-service prometheus-exporter if { path /metrics }

# -----------------------------------------------------------------------------
# BACKEND WEB SERVERS
# Pool de serveurs web avec load balancing
# -----------------------------------------------------------------------------
backend web_servers
    balance roundrobin
    
    # Health check HTTP
    option httpchk GET /health HTTP/1.1
    http-check expect status 200
    http-check send hdr Host localhost
    
    # Sticky sessions via cookie (optionnel)
    cookie SERVERID insert indirect nocache
    
    # Serveurs avec poids et health checks
    server web1 172.20.0.21:80 check inter 2000 fall 3 rise 2 weight 100 cookie web1
    server web2 172.20.0.22:80 check inter 2000 fall 3 rise 2 weight 100 cookie web2
    server web3 172.20.0.23:80 check inter 2000 fall 3 rise 2 weight 50 cookie web3 backup

# -----------------------------------------------------------------------------
# BACKEND API SERVERS
# Pool de serveurs API
# -----------------------------------------------------------------------------
backend api_servers
    balance leastconn
    
    # Health check spécifique API
    option httpchk GET /health HTTP/1.1
    http-check expect status 200
    
    # Timeout plus long pour API
    timeout server 60s
    timeout queue 120s
    
    # Headers pour le backend
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Real-IP %[src]
    
    server api1 172.20.0.31:8080 check inter 3000 fall 3 rise 2

# -----------------------------------------------------------------------------
# BACKEND HEALTH
# Endpoint de health check simple
# -----------------------------------------------------------------------------
backend health_backend
    mode http
    
    # Réponse directe sans serveur backend
    http-request return status 200 content-type "application/json" lf-string '{"status":"healthy","haproxy":"ok"}'

# -----------------------------------------------------------------------------
# BACKEND STATS (alternatif)
# -----------------------------------------------------------------------------
backend stats_backend
    mode http
    stats enable
    stats uri /
    stats refresh 5s
    stats auth admin:P@ssw0rd_HAProxy_2024!
