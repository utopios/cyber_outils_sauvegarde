# =============================================================================
# CONFIGURATION HAPROXY - LAB PS/PCA
# =============================================================================

global
    log stdout format raw local0
    maxconn 4096
    stats socket /tmp/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# -----------------------------------------------------------------------------
# Frontend HTTP
# -----------------------------------------------------------------------------
frontend http_front
    bind *:80
    default_backend web_backend

    # ACL pour l'API
    acl is_api path_beg /api
    use_backend api_backend if is_api

# -----------------------------------------------------------------------------
# Frontend HTTPS
# -----------------------------------------------------------------------------
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/server.pem
    default_backend web_backend

    acl is_api path_beg /api
    use_backend api_backend if is_api

# -----------------------------------------------------------------------------
# Frontend Stats
# -----------------------------------------------------------------------------
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:P@ssw0rd_HAProxy_2024!
    http-request use-service prometheus-exporter if { path /metrics }

# -----------------------------------------------------------------------------
# Backend Web Servers
# -----------------------------------------------------------------------------
backend web_backend
    balance roundrobin
    option http-server-close
    option httpchk GET /health
    http-check expect status 200

    server web1 172.21.0.21:80 check inter 2s fall 3 rise 2
    server web2 172.21.0.22:80 check inter 2s fall 3 rise 2
    server web3 172.21.0.23:80 check inter 2s fall 3 rise 2 backup

# -----------------------------------------------------------------------------
# Backend API
# -----------------------------------------------------------------------------
backend api_backend
    balance roundrobin
    server api1 172.21.0.31:8080 check
