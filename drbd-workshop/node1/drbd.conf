# =============================================================================
# Configuration DRBD - Resource r0
# =============================================================================
# Ce fichier definit la ressource DRBD r0 pour le cluster a 2 noeuds.
# Protocol C = Synchrone (securite maximale, zero perte de donnees)
# =============================================================================

resource r0 {
    # Protocol de replication
    # A = Asynchrone (performance)
    # B = Semi-synchrone
    # C = Synchrone (securite maximale)
    protocol C;

    # Options de demarrage
    startup {
        # Temps d'attente pour la connexion au peer au demarrage
        wfc-timeout 60;
        # Temps d'attente si le cluster est degrade
        degr-wfc-timeout 30;
        # Temps d'attente si l'autre noeud est obsolete
        outdated-wfc-timeout 20;
    }

    # Options reseau
    net {
        # Taille des buffers reseau
        sndbuf-size 512k;
        rcvbuf-size 512k;

        # Taille maximale des buffers
        max-buffers 8000;
        max-epoch-size 8000;

        # Verification d'integrite (optionnel, impact performance)
        # verify-alg sha1;

        # Gestion du split-brain
        # 0 primary: les deux noeuds etaient secondary
        after-sb-0pri discard-zero-changes;
        # 1 primary: un noeud etait primary
        after-sb-1pri discard-secondary;
        # 2 primary: les deux noeuds etaient primary (split-brain reel)
        after-sb-2pri disconnect;

        # Timeout de connexion
        connect-int 10;
        ping-int 10;
        ping-timeout 5;
    }

    # Options disque
    disk {
        # Action en cas d'erreur I/O
        on-io-error detach;

        # Resynchronisation en arriere-plan
        resync-rate 100M;

        # Nombre d'extents Activity Log
        al-extents 3389;

        # Desactiver les flushes pour performance (attention en prod!)
        # no-disk-flushes;
        # no-md-flushes;
    }

    # Configuration du noeud 1
    on node1 {
        # Device DRBD expose aux applications
        device /dev/drbd0;

        # Disque physique sous-jacent
        disk /data/drbd-disk.img;

        # Adresse IP et port pour la replication
        address 172.28.0.11:7788;

        # Emplacement des metadonnees DRBD
        # internal = sur le meme disque
        # /dev/sdX = disque separe (recommande en prod)
        meta-disk internal;
    }

    # Configuration du noeud 2
    on node2 {
        device /dev/drbd0;
        disk /data/drbd-disk.img;
        address 172.28.0.12:7788;
        meta-disk internal;
    }
}
