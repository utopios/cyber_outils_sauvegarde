version: '3.8'

# =============================================================================
# Cluster Ceph Minimal pour Formation PS/PCA
# =============================================================================
# Architecture: 1 MON + 1 MGR + 3 OSD (simulation multi-host)
# Usage: docker-compose up -d
# =============================================================================

networks:
  ceph-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:
  # ---------------------------------------------------------------------------
  # Monitor (MON) - Cerveau du cluster
  # ---------------------------------------------------------------------------
  ceph-mon:
    image: quay.io/ceph/ceph:v18
    container_name: ceph-mon
    hostname: ceph-mon
    networks:
      ceph-network:
        ipv4_address: 172.20.0.10
    environment:
      - MON_IP=172.20.0.10
      - CEPH_PUBLIC_NETWORK=172.20.0.0/16
    volumes:
      - ceph-mon-data:/var/lib/ceph
      - ceph-etc:/etc/ceph
    command: ["ceph-mon", "--id", "mon1", "--mon-data", "/var/lib/ceph/mon/ceph-mon1"]
    healthcheck:
      test: ["CMD", "ceph", "-s"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # Manager (MGR) - Dashboard et métriques
  # ---------------------------------------------------------------------------
  ceph-mgr:
    image: quay.io/ceph/ceph:v18
    container_name: ceph-mgr
    hostname: ceph-mgr
    networks:
      ceph-network:
        ipv4_address: 172.20.0.11
    depends_on:
      - ceph-mon
    environment:
      - CEPH_PUBLIC_NETWORK=172.20.0.0/16
    volumes:
      - ceph-mgr-data:/var/lib/ceph
      - ceph-etc:/etc/ceph
    ports:
      - "8443:8443"  # Dashboard HTTPS
      - "9283:9283"  # Prometheus metrics
    command: ["ceph-mgr", "--id", "mgr1"]

  # ---------------------------------------------------------------------------
  # OSD 1 - Object Storage Daemon (Rack A simulé)
  # ---------------------------------------------------------------------------
  ceph-osd-0:
    image: quay.io/ceph/ceph:v18
    container_name: ceph-osd-0
    hostname: ceph-osd-0
    networks:
      ceph-network:
        ipv4_address: 172.20.0.20
    depends_on:
      - ceph-mon
    environment:
      - OSD_ID=0
      - CEPH_PUBLIC_NETWORK=172.20.0.0/16
    volumes:
      - ceph-osd-0-data:/var/lib/ceph/osd/ceph-0
      - ceph-etc:/etc/ceph
    privileged: true
    command: ["ceph-osd", "--id", "0", "--osd-data", "/var/lib/ceph/osd/ceph-0"]

  # ---------------------------------------------------------------------------
  # OSD 2 - Object Storage Daemon (Rack B simulé)
  # ---------------------------------------------------------------------------
  ceph-osd-1:
    image: quay.io/ceph/ceph:v18
    container_name: ceph-osd-1
    hostname: ceph-osd-1
    networks:
      ceph-network:
        ipv4_address: 172.20.0.21
    depends_on:
      - ceph-mon
    environment:
      - OSD_ID=1
      - CEPH_PUBLIC_NETWORK=172.20.0.0/16
    volumes:
      - ceph-osd-1-data:/var/lib/ceph/osd/ceph-1
      - ceph-etc:/etc/ceph
    privileged: true
    command: ["ceph-osd", "--id", "1", "--osd-data", "/var/lib/ceph/osd/ceph-1"]

  # ---------------------------------------------------------------------------
  # OSD 3 - Object Storage Daemon (Rack C simulé)
  # ---------------------------------------------------------------------------
  ceph-osd-2:
    image: quay.io/ceph/ceph:v18
    container_name: ceph-osd-2
    hostname: ceph-osd-2
    networks:
      ceph-network:
        ipv4_address: 172.20.0.22
    depends_on:
      - ceph-mon
    environment:
      - OSD_ID=2
      - CEPH_PUBLIC_NETWORK=172.20.0.0/16
    volumes:
      - ceph-osd-2-data:/var/lib/ceph/osd/ceph-2
      - ceph-etc:/etc/ceph
    privileged: true
    command: ["ceph-osd", "--id", "2", "--osd-data", "/var/lib/ceph/osd/ceph-2"]

  # ---------------------------------------------------------------------------
  # RADOS Gateway - Interface S3/Swift
  # ---------------------------------------------------------------------------
  ceph-rgw:
    image: quay.io/ceph/ceph:v18
    container_name: ceph-rgw
    hostname: ceph-rgw
    networks:
      ceph-network:
        ipv4_address: 172.20.0.30
    depends_on:
      - ceph-mon
      - ceph-mgr
    environment:
      - CEPH_PUBLIC_NETWORK=172.20.0.0/16
    volumes:
      - ceph-etc:/etc/ceph
    ports:
      - "7480:7480"  # S3 API
    command: ["radosgw", "--rgw-frontends", "beast port=7480"]

volumes:
  ceph-mon-data:
  ceph-mgr-data:
  ceph-osd-0-data:
  ceph-osd-1-data:
  ceph-osd-2-data:
  ceph-etc:
